<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Laporan Keuangan - GENZET HOME</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet"/>
  <style>
    body { background-color: #f8f9fa;
          overflow: auto;   /* atau scroll / auto */
  scrollbar-width: none; /* Firefox */
  -ms-overflow-style: none; /* IE & Edge lama */}
    .progress { height: 20px; }
    .progress-bar { font-size: 0; transition: width 0.8s ease; }
    td { vertical-align: middle; }
    table { table-layout: auto; width: 100%; }
.swal2-popup {
    overflow: hidden !important;
  }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

</head>
<body>

<my-navbar></my-navbar>

<div class="container mb-5">


  <div class="mb-3 text-end">
    <button class="btn btn-secondary" id="refreshBtn"><i class="fa-solid fa-rotate-right"></i></button>
  </div>

  <div class="row g-3 mb-4 text-center">
    <div class="col-md-3">
      <div class="p-3 border rounded bg-success text-white">
        <h6>Total Pemasukan</h6>
        <h5 id="totalPemasukan">Rp 0</h5>
      </div>
    </div>
    <div class="col-md-3">
      <div class="p-3 border rounded bg-danger text-white">
        <h6>Total Pengeluaran</h6>
        <h5 id="totalPengeluaran">Rp 0</h5>
      </div>
    </div>
    <div class="col-md-3">
      <div class="p-3 border rounded bg-warning text-dark">
        <h6>Total Assets</h6>
        <h5 id="totalAssets">Rp 0</h5>
      </div>
    </div>
    <div class="col-md-3">
      <div class="p-3 border rounded bg-primary text-white">
        <h6>Saldo Akhir</h6>
        <h5 id="saldoAkhir">Rp 0</h5>
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header bg-success text-white"><i class="fa-solid fa-chart-bar"></i> Perbandingan</div>
    <div class="card-body">
      <div class="mb-2"><small>Pemasukan</small></div>
      <div class="progress mb-3"><div id="progressPemasukan" class="progress-bar bg-success" style="width: 0%;"></div></div>
      <div class="mb-2"><small>Pengeluaran</small></div>
      <div class="progress mb-3"><div id="progressPengeluaran" class="progress-bar bg-danger" style="width: 0%;"></div></div>
      <div class="mb-2"><small>Assets</small></div>
      <div class="progress mb-3"><div id="progressAssets" class="progress-bar bg-warning" style="width: 0%;"></div></div>
      <div class="mb-2"><small>Saldo</small></div>
      <div class="progress"><div id="progressSaldo" class="progress-bar bg-primary" style="width: 0%;"></div></div>
    </div>
  </div>

 <div class="card mb-4">
    <div class="card-header bg-success text-white">
      <i class="fas fa-cloud-sun"></i> Cuaca Terkini Citra Mulya Raya Cibarusah
    </div>
    <div class="card-body">
      <table class="table table-borderless">
        <colgroup>
          <col style="width: 30px;">
          <col style="width: 140px;">
          <col style="width: 10px;">
          <col style="width: auto;">
        </colgroup>
        <tbody id="weather">
          <!-- Data cuaca inject disini -->
        </tbody>
      </table>
    </div>
  </div>


  <!-- âœ… Card HEADER & container -->
<div class="card mb-4">
  <div class="card-header bg-success text-white">
    <i class="fas fa-tasks"></i> Jadwal Jatuh Tempo
  </div>
  <div class="card-body">
    <!-- Card isi akan di-render di sini -->
    <div id="timeline" class="d-flex gap-3 overflow-auto"></div>
  </div>
</div>


</div>
  
 
    <div id="timeline" class="d-flex gap-3 overflow-auto pb-2"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Firebase & FontAwesome sudah ada -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCxjTmRPiF4OrRAsneB_SUi1SpGOgkwrYg",
    authDomain: "genzet-home.firebaseapp.com",
    projectId: "genzet-home",
    storageBucket: "genzet-home.appspot.com",
    messagingSenderId: "586231239859",
    appId: "1:586231239859:web:9fc3a69f2f2ef0bf8c8cc6"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const timelineDiv = document.getElementById("timeline");

  // âœ… Fungsi loadTimeline
  async function loadTimeline() {
    const snapshot = await getDocs(collection(db, "pelanggan"));
    const items = [];
    snapshot.forEach(doc => {
      const d = doc.data();
      items.push({
        nama: d.nama,
        paket: d.paket || '-',
        alamat: d.alamat || '-',
        kodePelanggan: d.kodePelanggan || '0000',
        nominal: d.nominal || 0,
        tglPasang: d.tglPemasangan
      });
    });

    // Urutkan berdasarkan tanggal pasang (tanggal saja)
    items.sort((a, b) => {
      const [ddA] = a.tglPasang.split('-').map(Number);
      const [ddB] = b.tglPasang.split('-').map(Number);
      return ddA - ddB;
    });

    const today = new Date();
    let html = '';

    // ðŸ‘‰ LOOP SETIAP ITEM âžœ HITUNG JATUH TEMPO & RENDER CARD
    items.forEach(item => {
      const [yyyy, mm, dd] = item.tglPasang.split('-').map(Number);

      // Buat tanggal jatuh tempo di bulan ini
      let jatuhTempo = new Date(today.getFullYear(), today.getMonth(), dd);

      // Jika tanggal sudah lewat, mundurkan ke bulan depan
      if (today.getDate() > dd) {
        jatuhTempo.setMonth(jatuhTempo.getMonth() + 1);
      }

      const diffTime = jatuhTempo - today;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      const isToday = diffDays === 0;
      const isWarning = diffDays <= 7 && diffDays >= 0;

      const cardClass = isWarning ? 'bg-danger text-white' : 'bg-light';

      html += `
        <div class="card ${cardClass} shadow-sm flex-shrink-0" style="min-width: 220px; cursor: pointer;"
          onclick="generateInvoice(
            '${item.nama.replace(/'/g, "\\'")}',
            '${item.paket.replace(/'/g, "\\'")}',
            '${item.alamat.replace(/'/g, "\\'")}',
            '${item.kodePelanggan}',
            ${item.nominal},
            '${item.tglPasang}'
          )">
          <div class="card-body">
            <h6 class="card-title mb-1">
              <i class="fas fa-user"></i> ${item.nama}
            </h6>
            <p class="card-text mb-1">
              <i class="fas fa-money-bill"></i> Rp ${Number(item.nominal).toLocaleString()}
            </p>
            <small class="${isWarning ? 'text-white' : 'text-muted'}">
              <i class="fas fa-calendar"></i> ${jatuhTempo.toLocaleDateString('id-ID')}
              ${isToday ? '<span class="badge bg-dark ms-1">Hari Ini</span>' : ''}
            </small>
          </div>
        </div>
      `;
    });

    timelineDiv.innerHTML = html || '<p class="text-muted">Tidak ada jadwal.</p>';
  }

  loadTimeline();

  // âœ… Fungsi generateInvoice
  window.generateInvoice = async function (nama, paket, alamat, kodePelanggan, nominal, tglPemasangan) {
    const { jsPDF } = window.jspdf;

    const periodeNow = new Date();
    const periodeStr = periodeNow.toLocaleString('id-ID', { month: 'long', year: 'numeric' });

    const [dd, mm, yyyy] = tglPemasangan.split('-').map(Number);
    const pemasanganDate = new Date(yyyy, mm - 1, dd);

    const pemasanganMonthYear = `${String(pemasanganDate.getMonth() + 1).padStart(2, '0')}${pemasanganDate.getFullYear()}`;
    const invoiceMonthYear = `${String(periodeNow.getMonth() + 1).padStart(2, '0')}${periodeNow.getFullYear()}`;

    const noInvoice = `INV-${kodePelanggan}${invoiceMonthYear}`;

    await Swal.fire({
      title: '<div style="font-size: .9rem;">Memproses Invoice...</div>',
      html: `<div style="overflow: hidden; min-height: 50px; display: flex; align-items: center; justify-content: center;">
        <div class="spinner-border text-primary" role="status"></div>
      </div>`,
      timer: 1000,
      allowOutsideClick: false,
      showConfirmButton: false,
      scrollbarPadding: false
    });

    const doc = new jsPDF();
    doc.setFillColor(0, 51, 153);
    doc.rect(0, 0, 210, 20, 'F');
    doc.setFontSize(16);
    doc.setTextColor(255, 255, 255);
    doc.text("GENZET HOME", 14, 12);
    doc.setFontSize(10);
    doc.text(`NO: ${noInvoice}`, 160, 12);

    doc.setTextColor(0, 0, 0);
    doc.setFontSize(12);
    doc.text("Bill To:", 14, 35);
    doc.text(nama, 14, 42);
    const alamatSplit = doc.splitTextToSize(alamat, 80);
    doc.text(alamatSplit, 14, 49);

    doc.text("From:", 130, 35);
    doc.text("GENZET HOME", 130, 42);
    doc.text("Jl. Bambu Apus, Jakarta Timur", 130, 49);

    const bodyRows = [
      [`Internet Paket ${paket}`, '1', periodeStr, `Rp ${Number(nominal).toLocaleString("id-ID")}`, `Rp ${Number(nominal).toLocaleString("id-ID")}`]
    ];

    if (pemasanganMonthYear === invoiceMonthYear) {
      bodyRows.push(['Jasa Instalasi', '1', periodeStr, `Rp ${Number(50000).toLocaleString("id-ID")}`, `Rp ${Number(50000).toLocaleString("id-ID")}`]);
    }

    const totalTagihan = bodyRows.reduce((sum, row) => sum + parseInt(row[4].replace(/[^\d]/g, ''), 10), 0);
    bodyRows.push([{ content: 'TOTAL', colSpan: 4, styles: { halign: 'right', fontStyle: 'bold' } }, `Rp ${Number(totalTagihan).toLocaleString("id-ID")}`]);

    doc.autoTable({
      startY: 75,
      head: [['Description', 'Qty', 'Periode', 'Price', 'Total']],
      body: bodyRows,
      styles: { fontSize: 12, cellPadding: 6 },
      headStyles: { fillColor: [0, 51, 153] },
      margin: { left: 15, right: 15 }
    });

    const tanggalStr = `${String(periodeNow.getDate()).padStart(2, '0')}-${String(periodeNow.getMonth() + 1).padStart(2, '0')}-${periodeNow.getFullYear()}`;
    doc.setFontSize(10);
    doc.text(`Tanggal: ${tanggalStr}`, 130, doc.lastAutoTable.finalY + 10);

    doc.text("Payment Information:", 14, doc.lastAutoTable.finalY + 10);
    doc.text("Bank: BANK BCA", 14, doc.lastAutoTable.finalY + 17);
    doc.text("No. Rek: 1234567890", 14, doc.lastAutoTable.finalY + 24);
    doc.text("Email: support@genzet.com", 14, doc.lastAutoTable.finalY + 31);

    const pdfBlob = doc.output('blob');
    const pdfUrl = URL.createObjectURL(pdfBlob);
    window.open(pdfUrl, '_blank');
  };
</script>

<script type="module">
  const API_KEY = "1c02b03323602402ca922b951c366cc9";
  const LAT = -6.3521;
  const LON = 107.0577;

  const weatherDiv = document.getElementById("weather");

  // âœ… Fungsi fetchWeather
  async function fetchWeather() {
    try {
      const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${LAT}&lon=${LON}&units=metric&lang=id&appid=${API_KEY}`);
      if (!response.ok) throw new Error("API error");
      const data = await response.json();
      renderWeather(data);
    } catch (error) {
      console.error(error);
      weatherDiv.innerHTML = `<p class="text-danger">Gagal mengambil data cuaca.</p>`;
    }
  }

  // âœ… Fungsi renderWeather
  function renderWeather(data) {
    const temp = data.main.temp;
    const condition = data.weather[0].description;
    const humidity = data.main.humidity;
    const wind = data.wind.speed;

    weatherDiv.innerHTML = `
      <tr><td class="text-success align-middle"><i class="fas fa-temperature-high"></i></td>
      <td class="align-middle text-nowrap"><strong>Suhu</strong></td><td class="align-middle text-end px-1">:</td><td class="align-middle">${temp}Â°C</td></tr>
      <tr><td class="text-success align-middle"><i class="fas fa-cloud"></i></td>
      <td class="align-middle text-nowrap"><strong>Kondisi</strong></td><td class="align-middle text-end px-1">:</td><td class="align-middle">${condition}</td></tr>
      <tr><td class="text-success align-middle"><i class="fas fa-tint"></i></td>
      <td class="align-middle text-nowrap"><strong>Kelembapan</strong></td><td class="align-middle text-end px-1">:</td><td class="align-middle">${humidity}%</td></tr>
      <tr><td class="text-success align-middle"><i class="fas fa-wind"></i></td>
      <td class="align-middle text-nowrap"><strong>Angin</strong></td><td class="align-middle text-end px-1">:</td><td class="align-middle">${wind} m/s</td></tr>`;
  }

  fetchWeather();
  setInterval(fetchWeather, 5 * 60 * 1000);
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
  import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCxjTmRPiF4OrRAsneB_SUi1SpGOgkwrYg",
    authDomain: "genzet-home.firebaseapp.com",
    projectId: "genzet-home",
    storageBucket: "genzet-home.appspot.com",
    messagingSenderId: "586231239859",
    appId: "1:586231239859:web:9fc3a69f2f2ef0bf8c8cc6"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let totalPemasukan = 0, totalPengeluaran = 0, totalAssets = 0, saldo = 0;

  // âœ… Fungsi auth state observer
  onAuthStateChanged(auth, (user) => {
    if (!user) window.location.href = "login.html";
    else refreshLaporan();
  });

  // âœ… Fungsi refreshLaporan
  async function refreshLaporan() {
    totalPemasukan = totalPengeluaran = totalAssets = saldo = 0;

    const pemasukanSnap = await getDocs(collection(db, "pemasukan"));
    pemasukanSnap.forEach(doc => totalPemasukan += parseInt(doc.data().jumlah || 0));

    const pengeluaranSnap = await getDocs(collection(db, "pengeluaran"));
    pengeluaranSnap.forEach(doc => totalPengeluaran += parseInt(doc.data().jumlah || 0));

    const assetsSnap = await getDocs(collection(db, "assets"));
    assetsSnap.forEach(doc => totalAssets += parseInt(doc.data().jumlah || 0));

    saldo = totalPemasukan - totalPengeluaran;

    animateNumber("totalPemasukan", totalPemasukan);
    animateNumber("totalPengeluaran", totalPengeluaran);
    animateNumber("totalAssets", totalAssets);
    animateNumber("saldoAkhir", saldo);

    tampilkanProgress(totalPemasukan, totalPengeluaran, totalAssets, saldo);
  }

  // âœ… Fungsi tampilkanProgress
  function tampilkanProgress(pemasukan, pengeluaran, assets, saldo) {
    const total = pemasukan + pengeluaran + assets + Math.abs(saldo);
    const persenPemasukan = pemasukan > 0 ? Math.round((pemasukan / total) * 100) : 0;
    const persenPengeluaran = pengeluaran > 0 ? Math.round((pengeluaran / total) * 100) : 0;
    const persenAssets = assets > 0 ? Math.round((assets / total) * 100) : 0;
    const persenSaldo = saldo !== 0 ? Math.round((Math.abs(saldo) / total) * 100) : 0;

    document.getElementById("progressPemasukan").style.width = "0%";
    document.getElementById("progressPengeluaran").style.width = "0%";
    document.getElementById("progressAssets").style.width = "0%";
    document.getElementById("progressSaldo").style.width = "0%";

    setTimeout(() => {
      document.getElementById("progressPemasukan").style.width = persenPemasukan + "%";
      document.getElementById("progressPengeluaran").style.width = persenPengeluaran + "%";
      document.getElementById("progressAssets").style.width = persenAssets + "%";
      document.getElementById("progressSaldo").style.width = persenSaldo + "%";
    }, 100);
  }

  // âœ… Fungsi animateNumber
  function animateNumber(elementId, targetValue) {
    const el = document.getElementById(elementId);
    let start = 0;
    const duration = 500;
    const startTime = performance.now();

    function updateNumber(currentTime) {
      const elapsed = currentTime - startTime;
      const progress = Math.min(elapsed / duration, 1);
      const value = Math.floor(progress * targetValue);
      el.textContent = "Rp " + value.toLocaleString();
      if (progress < 1) requestAnimationFrame(updateNumber);
    }

    requestAnimationFrame(updateNumber);
  }

  document.getElementById("refreshBtn").addEventListener("click", refreshLaporan);

  // âœ… Komponen MyNavbar
  class MyNavbar extends HTMLElement {
    connectedCallback() {
      this.innerHTML = `
        <nav class="navbar navbar-expand-lg navbar-light mb-4 border-bottom border-secondary-subtle">
          <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="#">GENZET HOME</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
              <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
               <ul class="navbar-nav ms-auto">
                 <li class="nav-item"><a href="/cpanel.html" class="nav-link text-dark"><i class="fa-solid fa-chart-line"></i> Laporan</a></li>
                 <li class="nav-item"><a href="/pemasukan.html" class="nav-link text-dark"><i class="fa-solid fa-wallet"></i> Pemasukan</a></li>
                 <li class="nav-item"><a href="/pengeluaran.html" class="nav-link text-dark"><i class="fa-solid fa-money-bill-wave"></i> Pengeluaran</a></li>
                 <li class="nav-item"><a href="/assets.html" class="nav-link text-dark"><i class="fa-solid fa-box-archive"></i> Assets</a></li>
                 <li class="nav-item"><a href="/form.html" class="nav-link text-dark"><i class="fa-solid fa-file-lines"></i> Formulir</a></li>
                 <li class="nav-item"><a href="/approval.html" class="nav-link text-dark"><i class="fa-solid fa-circle-check"></i> Approval</a></li>
                 <li class="nav-item"><a href="/pelanggan.html" class="nav-link text-dark"><i class="fa-solid fa-users"></i> Pelanggan</a></li>
                 <li class="nav-item"><a href="#" id="logoutBtn" class="nav-link text-dark"><i class="fa-solid fa-right-from-bracket"></i> Logout</a></li>
               </ul>
            </div>
          </div>
        </nav>
      `;
      setTimeout(() => {
        this.querySelector("#logoutBtn")?.addEventListener("click", (e) => {
          e.preventDefault();
          logout();
        });
      }, 0);
    }
  }

  customElements.define('my-navbar', MyNavbar);

  // âœ… Fungsi logout
  window.logout = async function () {
    const result = await Swal.fire({
      title: "Keluar dari akun?",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Ya, Logout"
    });
    if (result.isConfirmed) {
      await signOut(auth);
      Swal.fire("Logout berhasil", "", "success").then(() => location.href = "login.html");
    }
  };
</script>

</body>
</html>
