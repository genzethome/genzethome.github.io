<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Laporan Keuangan - GENZET HOME</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet"/>
  <style>
    body { background-color: #f8f9fa;
          overflow: auto;   /* atau scroll / auto */
  scrollbar-width: none; /* Firefox */
  -ms-overflow-style: none; /* IE & Edge lama */}
    .progress { height: 20px; }
    .progress-bar { font-size: 0; transition: width 0.8s ease; }
    td { vertical-align: middle; }
    table { table-layout: auto; width: 100%; }

  </style>
</head>
<body>

<my-navbar></my-navbar>

<div class="container mb-5">


  <div class="mb-3 text-end">
    <button class="btn btn-secondary" id="refreshBtn"><i class="fa-solid fa-rotate-right"></i></button>
  </div>

  <div class="row g-3 mb-4 text-center">
    <div class="col-md-3">
      <div class="p-3 border rounded bg-success text-white">
        <h6>Total Pemasukan</h6>
        <h5 id="totalPemasukan">Rp 0</h5>
      </div>
    </div>
    <div class="col-md-3">
      <div class="p-3 border rounded bg-danger text-white">
        <h6>Total Pengeluaran</h6>
        <h5 id="totalPengeluaran">Rp 0</h5>
      </div>
    </div>
    <div class="col-md-3">
      <div class="p-3 border rounded bg-warning text-dark">
        <h6>Total Assets</h6>
        <h5 id="totalAssets">Rp 0</h5>
      </div>
    </div>
    <div class="col-md-3">
      <div class="p-3 border rounded bg-primary text-white">
        <h6>Saldo Akhir</h6>
        <h5 id="saldoAkhir">Rp 0</h5>
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header bg-primary text-white"><i class="fa-solid fa-chart-bar"></i> Perbandingan</div>
    <div class="card-body">
      <div class="mb-2"><small>Pemasukan</small></div>
      <div class="progress mb-3"><div id="progressPemasukan" class="progress-bar bg-success" style="width: 0%;"></div></div>
      <div class="mb-2"><small>Pengeluaran</small></div>
      <div class="progress mb-3"><div id="progressPengeluaran" class="progress-bar bg-danger" style="width: 0%;"></div></div>
      <div class="mb-2"><small>Assets</small></div>
      <div class="progress mb-3"><div id="progressAssets" class="progress-bar bg-warning" style="width: 0%;"></div></div>
      <div class="mb-2"><small>Saldo</small></div>
      <div class="progress"><div id="progressSaldo" class="progress-bar bg-primary" style="width: 0%;"></div></div>
    </div>
  </div>

 <div class="card mb-4">
    <div class="card-header bg-success text-white">
      <i class="fas fa-cloud-sun"></i> Cuaca Terkini Citra Mulya Raya Cibarusah
    </div>
    <div class="card-body">
      <table class="table table-borderless">
        <colgroup>
          <col style="width: 30px;">
          <col style="width: 140px;">
          <col style="width: 10px;">
          <col style="width: auto;">
        </colgroup>
        <tbody id="weather">
          <!-- Data cuaca inject disini -->
        </tbody>
      </table>
    </div>
  </div>


  <!-- ✅ Card HEADER & container -->
<div class="card mb-4">
  <div class="card-header bg-success text-white">
    <i class="fas fa-tasks"></i> Jadwal Jatuh Tempo
  </div>
  <div class="card-body">
    <!-- Card isi akan di-render di sini -->
    <div id="timeline" class="d-flex gap-3 overflow-auto"></div>
  </div>
</div>


</div>
  

  
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  
 
    <div id="timeline" class="d-flex gap-3 overflow-auto pb-2"></div>



<!-- Firebase & FontAwesome sudah ada -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCxjTmRPiF4OrRAsneB_SUi1SpGOgkwrYg",
    authDomain: "genzet-home.firebaseapp.com",
    projectId: "genzet-home",
    storageBucket: "genzet-home.appspot.com",
    messagingSenderId: "586231239859",
    appId: "1:586231239859:web:9fc3a69f2f2ef0bf8c8cc6"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const timelineDiv = document.getElementById("timeline");

  async function loadTimeline() {
    const snapshot = await getDocs(collection(db, "pelanggan"));
    const items = [];
    snapshot.forEach(doc => {
      const d = doc.data();
      items.push({
        nama: d.nama,
        nominal: d.nominal,
        tglPasang: d.tglPemasangan // format: dd-mm-yyyy
      });
    });

    items.sort((a, b) => {
      const [ddA, mmA, yyyyA] = a.tglPasang.split('-').map(Number);
      const [ddB, mmB, yyyyB] = b.tglPasang.split('-').map(Number);
      return ddA - ddB;
    });

    const today = new Date();
    let html = '';

    items.forEach(item => {
  const [yyyy, mm, dd] = item.tglPasang.split('-').map(Number);

  // Tanggal pasang ➜ update ke bulan sekarang
  let jatuhTempo = new Date(today.getFullYear(), today.getMonth(), dd);

  // Kalau sudah lewat, bulan depan
  if (today.getDate() > dd) {
    jatuhTempo.setMonth(jatuhTempo.getMonth() + 1);
  }

  const diffTime = jatuhTempo - today;
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  const isToday = diffDays === 0;
  const isWarning = diffDays <= 7 && diffDays >= 0;

  const cardClass = isWarning ? 'bg-danger text-white' : 'bg-light';

  html += `
    <div class="card ${cardClass} shadow-sm flex-shrink-0" style="min-width: 220px;">
      <div class="card-body">
        <h6 class="card-title mb-1">
          <i class="fas fa-user"></i> ${item.nama}
        </h6>
        <p class="card-text mb-1">
          <i class="fas fa-money-bill"></i> Rp ${Number(item.nominal).toLocaleString()}
        </p>
        <small class="text-muted ${isWarning ? 'text-white' : ''}">
          <i class="fas fa-calendar"></i> ${jatuhTempo.toLocaleDateString('id-ID')}
          ${isToday ? '<span class="badge bg-dark ms-1">Hari Ini</span>' : ''}
        </small>
      </div>
    </div>
  `;
});

    timelineDiv.innerHTML = html || '<p class="text-muted">Tidak ada jadwal.</p>';
  }

  loadTimeline();
</script>


   <script type="module">
    const API_KEY = "1c02b03323602402ca922b951c366cc9";
    const LAT = -6.3521;
    const LON = 107.0577;

    const weatherDiv = document.getElementById("weather");

    async function fetchWeather() {
      try {
        const response = await fetch(
          `https://api.openweathermap.org/data/2.5/weather?lat=${LAT}&lon=${LON}&units=metric&lang=id&appid=${API_KEY}`
        );
        if (!response.ok) throw new Error("API error");
        const data = await response.json();
        renderWeather(data);
      } catch (error) {
        console.error(error);
        weatherDiv.innerHTML = `<p class="text-danger">Gagal mengambil data cuaca.</p>`;
      }
    }

    function renderWeather(data) {
  const temp = data.main.temp;
  const condition = data.weather[0].description;
  const humidity = data.main.humidity;
  const wind = data.wind.speed;

  weatherDiv.innerHTML = `
  <tr>
      <td class="text-success align-middle"><i class="fas fa-temperature-high"></i></td>
      <td class="align-middle text-nowrap"><strong>Suhu</strong></td>
      <td class="align-middle text-end px-1">:</td>
      <td class="align-middle">${temp}°C</td>
    </tr>
    <tr>
      <td class="text-success align-middle"><i class="fas fa-cloud"></i></td>
      <td class="align-middle text-nowrap"><strong>Kondisi</strong></td>
      <td class="align-middle text-end px-1">:</td>
      <td class="align-middle">${condition}</td>
    </tr>
    <tr>
      <td class="text-success align-middle"><i class="fas fa-tint"></i></td>
      <td class="align-middle text-nowrap"><strong>Kelembapan</strong></td>
      <td class="align-middle text-end px-1">:</td>
      <td class="align-middle">${humidity}%</td>
    </tr>
    <tr>
      <td class="text-success align-middle"><i class="fas fa-wind"></i></td>
      <td class="align-middle text-nowrap"><strong>Angin</strong></td>
      <td class="align-middle text-end px-1">:</td>
      <td class="align-middle">${wind} m/s</td>
    </tr>
   
`;
}







    fetchWeather();
    setInterval(fetchWeather, 5 * 60 * 1000);
  </script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
  import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCxjTmRPiF4OrRAsneB_SUi1SpGOgkwrYg",
    authDomain: "genzet-home.firebaseapp.com",
    projectId: "genzet-home",
    storageBucket: "genzet-home.appspot.com",
    messagingSenderId: "586231239859",
    appId: "1:586231239859:web:9fc3a69f2f2ef0bf8c8cc6"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let totalPemasukan = 0, totalPengeluaran = 0, totalAssets = 0, saldo = 0;

  onAuthStateChanged(auth, (user) => {
    if (!user) window.location.href = "login.html";
    else refreshLaporan();
  });

  async function refreshLaporan() {
    totalPemasukan = totalPengeluaran = totalAssets = saldo = 0;

    const pemasukanSnap = await getDocs(collection(db, "pemasukan"));
    pemasukanSnap.forEach(doc => totalPemasukan += parseInt(doc.data().jumlah || 0));

    const pengeluaranSnap = await getDocs(collection(db, "pengeluaran"));
    pengeluaranSnap.forEach(doc => totalPengeluaran += parseInt(doc.data().jumlah || 0));

    const assetsSnap = await getDocs(collection(db, "assets"));
    assetsSnap.forEach(doc => totalAssets += parseInt(doc.data().jumlah || 0));

    saldo = totalPemasukan - totalPengeluaran;

    animateNumber("totalPemasukan", totalPemasukan);
    animateNumber("totalPengeluaran", totalPengeluaran);
    animateNumber("totalAssets", totalAssets);
    animateNumber("saldoAkhir", saldo);

    tampilkanProgress(totalPemasukan, totalPengeluaran, totalAssets, saldo);
  }

  function tampilkanProgress(pemasukan, pengeluaran, assets, saldo) {
    const total = pemasukan + pengeluaran + assets + Math.abs(saldo);
    const persenPemasukan = pemasukan > 0 ? Math.round((pemasukan / total) * 100) : 0;
    const persenPengeluaran = pengeluaran > 0 ? Math.round((pengeluaran / total) * 100) : 0;
    const persenAssets = assets > 0 ? Math.round((assets / total) * 100) : 0;
    const persenSaldo = saldo !== 0 ? Math.round((Math.abs(saldo) / total) * 100) : 0;

    document.getElementById("progressPemasukan").style.width = "0%";
    document.getElementById("progressPengeluaran").style.width = "0%";
    document.getElementById("progressAssets").style.width = "0%";
    document.getElementById("progressSaldo").style.width = "0%";

    setTimeout(() => {
      document.getElementById("progressPemasukan").style.width = persenPemasukan + "%";
      document.getElementById("progressPengeluaran").style.width = persenPengeluaran + "%";
      document.getElementById("progressAssets").style.width = persenAssets + "%";
      document.getElementById("progressSaldo").style.width = persenSaldo + "%";
    }, 100);
  }

  function animateNumber(elementId, targetValue) {
    const el = document.getElementById(elementId);
    let start = 0;
    const duration = 500;
    const startTime = performance.now();

    function updateNumber(currentTime) {
      const elapsed = currentTime - startTime;
      const progress = Math.min(elapsed / duration, 1);
      const value = Math.floor(progress * targetValue);
      el.textContent = "Rp " + value.toLocaleString();
      if (progress < 1) requestAnimationFrame(updateNumber);
    }
    requestAnimationFrame(updateNumber);
  }

  document.getElementById("refreshBtn").addEventListener("click", refreshLaporan);

  class MyNavbar extends HTMLElement {
    connectedCallback() {
      this.innerHTML = `
        <nav class="navbar navbar-expand-lg navbar-light mb-4 border-bottom border-secondary-subtle">
          <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="#">GENZET HOME</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
              <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
               <ul class="navbar-nav ms-auto">
  <li class="nav-item"><a href="/cpanel.html" class="nav-link text-dark"><i class="fa-solid fa-chart-line"></i> Laporan</a></li>
  <li class="nav-item"><a href="/pemasukan.html" class="nav-link text-dark"><i class="fa-solid fa-wallet"></i> Pemasukan</a></li>
  <li class="nav-item"><a href="/pengeluaran.html" class="nav-link text-dark"><i class="fa-solid fa-money-bill-wave"></i> Pengeluaran</a></li>
  <li class="nav-item"><a href="/assets.html" class="nav-link text-dark"><i class="fa-solid fa-box-archive"></i> Assets</a></li>
  <li class="nav-item"><a href="/form.html" class="nav-link text-dark"><i class="fa-solid fa-file-lines"></i> Formulir</a></li>
  <!-- ✅ Tambahan Approval -->
  <li class="nav-item"><a href="/approval.html" class="nav-link text-dark"><i class="fa-solid fa-circle-check"></i> Approval</a></li>
  <li class="nav-item"><a href="/pelanggan.html" class="nav-link text-dark"><i class="fa-solid fa-users"></i> Pelanggan</a></li>
  <li class="nav-item"><a href="#" id="logoutBtn" class="nav-link text-dark"><i class="fa-solid fa-right-from-bracket"></i> Logout</a></li>
</ul>
            </div>
          </div>
        </nav>
      `;
      setTimeout(() => {
        this.querySelector("#logoutBtn")?.addEventListener("click", (e) => {
          e.preventDefault();
          logout();
        });
      }, 0);
    }
  }
  customElements.define('my-navbar', MyNavbar);

  window.logout = async function () {
    const result = await Swal.fire({
      title: "Keluar dari akun?",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Ya, Logout"
    });
    if (result.isConfirmed) {
      await signOut(auth);
      Swal.fire("Logout berhasil", "", "success").then(() => location.href = "login.html");
    }
  }
</script>
</body>
</html>
